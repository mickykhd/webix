<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Pivot: Edit Data</title>
		<!-- Webix Library -->
		<script type="text/javascript" src="../../codebase/webix/webix.js"></script>
		<link
			rel="stylesheet"
			type="text/css"
			href="../../codebase/webix/webix.css"
		/>

		<!-- pivot -->
		<script type="text/javascript" src="../../codebase/pivot.js"></script>
		<link rel="stylesheet" type="text/css" href="../../codebase/pivot.css" />
	</head>
	<body>
		<script>
			webix.ready(function() {
				webix.CustomScroll.init();

				let editedData;
				class MyBackend extends pivot.services.Backend {
					data() {
						if (editedData) return webix.promise.resolve(editedData);
						return super.data().then(res => {
							editedData = webix.copy(res);
							return res;
						});
					}
				}

				webix.ui({
					visibleBatch: "pivot",
					rows: [
						{
							view: "pivot",
							batch: "pivot",
							id: "pivot",
							structure: {
								rows: ["form", "name"],
								columns: ["year"],
								values: [{ name: "oil", operation: ["min", "sum"] }],
							},
							url: "../common/data.json",
							override: new Map([[pivot.services.Backend, MyBackend]]),
						},
						{
							view: "button",
							batch: "pivot",
							label: "Edit data",
							css: "webix_primary",
							click: function() {
								this.getParentView().showBatch("edit");
								$$("table").parse(editedData);
								$$("table").select($$("table").getFirstId());
							},
						},
						{
							view: "datatable",
							batch: "edit",
							id: "table",
							autoConfig: true,
							editable: true,
							editaction: "custom",
							on: {
								onItemClick: function(id) {
									this.editRow(id);
								},
							},
						},
						{
							batch: "edit",
							cols: [
								{
									view: "button",
									batch: "edit",
									label: "Add row",
									click: function() {
										const table = $$("table");
										const id = table.add({});
										table.editRow(id);
										table.select(id);
									},
								},
								{
									view: "button",
									batch: "edit",
									label: "Remove row",
									click: function() {
										const table = $$("table");
										const selected = table.getSelectedId();
										if (selected) {
											table.select(table.getNextId(selected));
											table.editStop();
											table.remove(selected);
										}
									},
								},
							],
						},
						{
							view: "button",
							batch: "edit",
							label: "Save data",
							css: "webix_primary",
							click: function() {
								editedData = $$("table").serialize();
								this.getParentView().showBatch("pivot");
								$$("pivot")
									.getService("local")
									.getData(true)
									.then(() => {
										// force view rerender
										const structure = $$("pivot").getStructure();
										$$("pivot").setStructure({});
										$$("pivot").setStructure(structure);
									});
							},
						},
					],
				});
			});
		</script>
	</body>
</html>
